#include "sort.h"

/*================================================================*/
int analyze_fragment(Tig10_event* ptr,short* waveform)
{
  int d;
  WaveFormPar wpar;
  int show;
  double t;
  if(ptr->channel==chn)
    if((d=ptr->waveform_length)!=0)
    {
      memset(&wpar,0,sizeof(WaveFormPar));
      wpar.baseline_range=RANGE;
      get_sig2noise(ptr->waveform_length,waveform,&wpar);
      show=0;
      f[0]++;
      if(wpar.sig2noise>18)
	{
	  get_t50(ptr->waveform_length,waveform,&wpar);
	  if(wpar.t50_flag==1)
	    {
	      if(wpar.t50>230)
		{
		  if(wpar.t50<430)
		    {
		      get_t90(ptr->waveform_length,waveform,&wpar);
		      if(wpar.t90_flag==1)
			{
			  if(wpar.t90>230)
			    {
			      if(wpar.t90<430)
				{
				  f[1]++;			
				  h->Fill(wpar.t90);
				}
			      else 
				{
				  f[8]++;
				  //	  show=1;
				}
			    }
			  else
			    f[7]++;
			}
		      else
			f[6]++;
		      
		    }
		  else
		    f[5]++;
		}
	      else
		f[4]++;
	    }
	  else
	    f[3]++;
	}
      else
	f[2]++;
      

      if(show==1)
     
      	{
      	  printf("t50 %10.2f\n",wpar.t50);
      	  if(w!=NULL) delete w;
      	  w=new TH1D("Waveform","Waveform",ptr->waveform_length,0,ptr->waveform_length);
      	  if(c!=NULL) delete c;
      	  c = new TCanvas("Waveform", "Waveform",10,10, 700, 500);
	  
      	  for(Int_t i=0;i<ptr->waveform_length;i++)
      	    w->Fill(i,waveform[i]);
	  
      	  w->Draw();
      	  theApp->Run(kTRUE);
      	}
   
    }
  
  return 0;
}
/*================================================================*/
int main(int argc, char *argv[])
{

  int ac;
  char *av[10];

 if(argc!=3)
    {
      printf("\n ./wfit_test_tmax midas_input_data_file_name channel\n");
      exit(-1);
    }


  chn=atoi(argv[2]);
  h=new TH1D("t90t10","t90t10",S32K,0,S32K);
  h->Reset();
  theApp=new TApplication("App", &ac, av);
  memset(f,0,sizeof(f));

/* do sorting */
  sort_but_not_assemble(argv[1]);
 /* display results */
  printf("Program shows waveform maximum for selected channel\n");

  for(int d=0;d<20;d++)
    printf(" %4d %10d\n",d,f[d]);
  
  c = new TCanvas("bsq", "bsq",10,10, 700, 500);
  h->Draw();
  theApp->Run(kTRUE);
}
